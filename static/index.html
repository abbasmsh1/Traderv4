<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading System Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .card {
            margin-bottom: 20px;
        }
        .market-pair {
            cursor: pointer;
        }
        .market-pair:hover {
            background-color: #f8f9fa;
        }
        #analysisHistory {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Trading System Dashboard</span>
            <div class="d-flex text-light">
                <div id="walletValue" class="me-3"></div>
                <div id="availableUSD"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Market Overview -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Market Overview
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="marketOverview">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Price</th>
                                        <th>24h Change</th>
                                        <th>RSI</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Positions -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Current Positions
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="positions">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Amount</th>
                                        <th>Avg Price</th>
                                        <th>Current Value</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Analysis -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Latest Analysis
                        <button class="btn btn-sm btn-primary float-end" onclick="requestAnalysis()">
                            Request Analysis
                        </button>
                    </div>
                    <div class="card-body" id="latestAnalysis">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Trade History -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Trade History
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="tradeHistory">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th>Amount</th>
                                        <th>Price</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis History -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Analysis History
                    </div>
                    <div class="card-body" id="analysisHistory">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8000';
        let updateInterval;

        async function fetchData() {
            try {
                const [wallet, market, trades, analyses] = await Promise.all([
                    fetch(`${API_URL}/wallet`).then(r => r.json()),
                    fetch(`${API_URL}/market/overview`).then(r => r.json()),
                    fetch(`${API_URL}/trades/history`).then(r => r.json()),
                    fetch(`${API_URL}/analysis/history`).then(r => r.json())
                ]);

                updateWallet(wallet);
                updateMarketOverview(market);
                updateTradeHistory(trades);
                updateAnalysisHistory(analyses);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function updateWallet(wallet) {
            document.getElementById('walletValue').textContent = 
                `Total Value: $${wallet.total_value.toFixed(2)}`;
            document.getElementById('availableUSD').textContent = 
                `Available USD: $${wallet.current_balance_usd.toFixed(2)}`;

            const positionsTable = document.getElementById('positions').getElementsByTagName('tbody')[0];
            positionsTable.innerHTML = '';
            
            Object.entries(wallet.positions).forEach(([symbol, position]) => {
                const row = positionsTable.insertRow();
                row.innerHTML = `
                    <td>${symbol}</td>
                    <td>${position.amount.toFixed(8)}</td>
                    <td>$${position.avg_price.toFixed(2)}</td>
                    <td>$${(position.amount * position.avg_price).toFixed(2)}</td>
                `;
            });
        }

        function updateMarketOverview(market) {
            const table = document.getElementById('marketOverview').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            
            market.forEach(pair => {
                const row = table.insertRow();
                const changeClass = pair.price_change_24h >= 0 ? 'text-success' : 'text-danger';
                row.innerHTML = `
                    <td>${pair.symbol}</td>
                    <td>$${pair.price.toFixed(2)}</td>
                    <td class="${changeClass}">${pair.price_change_24h.toFixed(2)}%</td>
                    <td>${pair.rsi.toFixed(1)}</td>
                `;
            });
        }

        function updateTradeHistory(trades) {
            const table = document.getElementById('tradeHistory').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            
            trades.slice().reverse().forEach(trade => {
                const row = table.insertRow();
                const date = new Date(trade.timestamp).toLocaleString();
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${trade.symbol}</td>
                    <td>${trade.side}</td>
                    <td>${trade.amount.toFixed(8)}</td>
                    <td>$${trade.price.toFixed(2)}</td>
                    <td>$${trade.value_usd.toFixed(2)}</td>
                `;
            });
        }

        function updateAnalysisHistory(analyses) {
            const container = document.getElementById('analysisHistory');
            container.innerHTML = '';
            
            analyses.slice().reverse().forEach(analysis => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-header">
                        Analysis from ${new Date(analysis.timestamp).toLocaleString()}
                    </div>
                    <div class="card-body">
                        <h6>Trader Analysis</h6>
                        <p>${analysis.trader_analysis}</p>
                        <h6>Risk Assessment</h6>
                        <p>${analysis.risk_analysis}</p>
                        <h6>Technical Analysis</h6>
                        <p>${analysis.technical_analysis}</p>
                        <h6>Financial Analysis</h6>
                        <p>${analysis.financial_analysis}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function requestAnalysis() {
            try {
                const analysis = await fetch(`${API_URL}/analysis/latest`).then(r => r.json());
                const container = document.getElementById('latestAnalysis');
                container.innerHTML = `
                    <h6>Trader Analysis</h6>
                    <p>${analysis.trader_analysis}</p>
                    <h6>Risk Assessment</h6>
                    <p>${analysis.risk_analysis}</p>
                    <h6>Technical Analysis</h6>
                    <p>${analysis.technical_analysis}</p>
                    <h6>Financial Analysis</h6>
                    <p>${analysis.financial_analysis}</p>
                `;
            } catch (error) {
                console.error('Error requesting analysis:', error);
            }
        }

        // Initial load and set up auto-refresh
        fetchData();
        updateInterval = setInterval(fetchData, 30000); // Update every 30 seconds
    </script>
</body>
</html>
